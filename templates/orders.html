{% extends 'base.html' %}

{% block content %}
<div class="page-header" style="margin-bottom: 2rem; display: flex; justify-content: space-between;">
    <h2 style="font-size: 1.5rem; font-weight: 600;">{{ t('orders') }}</h2>
    <!-- Auto-created from measurements now -->
    <div style="display: flex; gap: 1rem; align-items: center;">
        <div class="month-nav"
            style="display: flex; align-items: center; background: var(--card-bg); padding: 0.25rem; border-radius: 0.375rem; border: 1px solid var(--border-color);">
            <a href="{{ month_nav.prev_url }}" class="btn btn-sm btn-ghost" title="Previous Month"
                style="color: var(--text-secondary);">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            <span
                style="padding: 0 1rem; font-weight: 600; color: var(--text-primary); min-width: 140px; text-align: center;">
                {{ month_nav.current }}
            </span>
            <a href="{{ month_nav.next_url }}" class="btn btn-sm btn-ghost" title="Next Month"
                style="color: var(--text-secondary);">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form action="{{ url_for('orders') }}" method="GET" class="filter-bar"
        style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">

        <!-- Search -->
        <div style="flex: 1; min-width: 200px; position: relative;">
            <i class="fa-solid fa-magnifying-glass"
                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
            <input type="text" name="q" value="{{ request.args.get('q', '') }}"
                placeholder="{{ t('search_name_mobile') }}"
                style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
        </div>

        <!-- Gender Filter -->
        <select name="gender" onchange="this.form.submit()"
            style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary); cursor: pointer;">
            <option value="">{{ t('all_genders') }}</option>
            <option value="male" {% if request.args.get('gender')=='male' %}selected{% endif %}>{{ t('male') }}</option>
            <option value="female" {% if request.args.get('gender')=='female' %}selected{% endif %}>{{ t('female') }}
            </option>
        </select>

        <!-- Balance/Status Filter -->
        <select name="status" onchange="this.form.submit()"
            style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary); cursor: pointer;">
            <option value="">{{ t('balance_all') }}</option>
            <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>{{
                t('pending_balance') }}
            </option>
            <option value="paid" {% if request.args.get('status')=='paid' %}selected{% endif %}>{{ t('all_paid') }}
            </option>
        </select>

        <!-- Reset Button -->
        {% if request.args.get('q') or request.args.get('gender') or request.args.get('status') %}
        <a href="{{ url_for('orders') }}" class="btn btn-outline"
            style="border: 1px solid var(--border-color); padding: 0.75rem;">
            <i class="fa-solid fa-xmark"></i>
        </a>
        {% endif %}
    </form>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>{{ t('order_id') }}</th>
                    <th>{{ t('customer') }}</th>
                    <th>{{ t('items') }}</th>
                    <th>{{ t('clothes_status') }}</th>
                    <th>{{ t('payment_status') }}</th>
                    <th>{{ t('balance') }}</th>
                    <th>{{ t('actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                    <td>
                        <div style="font-weight: 600;">{{ order.customer.name }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ order.customer.mobile }}</div>
                    </td>
                    <td>
                        {% for item in order.items %}
                        <span class="badge badge-secondary">{{ item.qty }}x {{ item.name }}</span>
                        {% endfor %}
                    </td>

                    <td>
                        {% if order.work_status == 'Pending' %}
                        <span class="badge badge-secondary" style="color: #4B5563;">Pending</span>
                        {% elif order.work_status == 'Processing' %}
                        <span class="badge badge-secondary" style="color: #1E40AF;">Processing</span>
                        {% elif order.work_status == 'Ready' %}
                        <span class="badge badge-secondary" style="color: #0284C7;">Completed</span>
                        {% elif order.work_status == 'Delivered' %}
                        <span class="badge badge-secondary" style="color: #166534;">Delivered</span>
                        {% else %}
                        <span>{{ order.work_status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.payment_status == 'Paid' %}
                        <span class="badge badge-primary" style="color: #047857;">Paid</span>
                        {% elif order.payment_status == 'Half-Payment' %}
                        <span class="badge badge-secondary" style="color: #D97706;">Half-Payment</span>
                        {% else %}
                        <span class="badge badge-secondary" style="color: #B91C1C;">Pending</span>
                        {% endif %}
                    </td>
                    <td>₹{{ order.balance }}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-primary" type="button" data-id="{{ order.id }}"
                                data-status="{{ order.work_status }}" data-total="{{ order.total_amt }}"
                                data-advance="{{ order.advance }}" data-mode="{{ order.payment_mode }}"
                                data-start="{{ order.created_at.strftime('%Y-%m-%d') }}"
                                data-delivery="{{ order.delivery_date.strftime('%Y-%m-%d') if order.delivery_date else 'None' }}"
                                data-creator="{{ order.bill_created_by or 'System' }}"
                                data-customer="{{ order.customer.name }}"
                                data-items="{% for i in order.items %}{{ i.qty }}x {{ i.name }}{% if not loop.last %}, {% endif %}{% endfor %}"
                                onclick="openManageOrder(this)" title="{{ t('manage_order') }}">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <form action="{{ url_for('delete_order', id=order.id) }}" method="POST"
                                onsubmit="return confirm('Delete this order?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit" class="btn btn-sm"
                                    style="background: rgba(220, 38, 38, 0.1); color: var(--danger-color); border: 1px solid var(--danger-color); transition: all 0.2s;"
                                    title="Delete Order">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">{{ t('no_orders_found') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
        <div style="font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; gap: 1rem;">
            <span>{{ t('showing_page') }} {{ pagination.page }} of {{ pagination.pages }}</span>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.8rem;">{{ t('go_to') }}:</span>
                <input type="number" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}"
                    class="form-input"
                    style="width: 70px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;"
                    data-base-url="{{ url_for('orders') }}" data-q="{{ request.args.get('q', '') }}"
                    data-status="{{ request.args.get('status', '') }}"
                    data-delivery-date="{{ request.args.get('delivery_date', '') }}"
                    data-month="{{ request.args.get('month', '') }}" data-year="{{ request.args.get('year', '') }}"
                    onchange="navigateToPage(this)">
            </div>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('orders', page=pagination.prev_num, q=request.args.get('q'), status=request.args.get('status'), delivery_date=request.args.get('delivery_date'), month=request.args.get('month'), year=request.args.get('year')) }}"
                class="btn btn-sm btn-outline" style="border: 1px solid var(--border-color); text-decoration: none;">
                <i class="fa-solid fa-chevron-left"></i> {{ t('prev') }}
            </a>
            {% else %}
            <button class="btn btn-sm btn-outline" disabled
                style="border: 1px solid var(--border-color); opacity: 0.5; cursor: not-allowed;">
                <i class="fa-solid fa-chevron-left"></i> {{ t('prev') }}
            </button>
            {% endif %}

            {% if pagination.has_next %}
            <a href="{{ url_for('orders', page=pagination.next_num, q=request.args.get('q'), status=request.args.get('status'), delivery_date=request.args.get('delivery_date'), month=request.args.get('month'), year=request.args.get('year')) }}"
                class="btn btn-sm btn-outline" style="border: 1px solid var(--border-color); text-decoration: none;">
                {{ t('next') }} <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="btn btn-sm btn-outline" disabled
                style="border: 1px solid var(--border-color); opacity: 0.5; cursor: not-allowed;">
                {{ t('next') }} <i class="fa-solid fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Unified Manage Order Modal -->
<div id="manageModal" class="sidebar-overlay" onclick="toggleModal('manageModal')">
    <div class="sidebar-panel" onclick="event.stopPropagation()">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
            <h3 style="font-size: 1.5rem; font-weight: 600;">{{ t('manage_order') }}</h3>
            <button onclick="toggleModal('manageModal')"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <form method="POST" action="{{ url_for('orders_update_details') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="order_id" id="manage_order_id">
            <!-- Hidden Fields/Preserved -->
            <input type="hidden" id="manage_start_date">

            <!-- Order Info (New) -->
            <div
                style="background: var(--bg-color); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 2rem;">
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">{{ t('customer')
                    }}</div>
                <div style="font-weight: 600; font-size: 1.1rem; color: var(--primary-color); margin-bottom: 0.75rem;"
                    id="manage_info_customer">-</div>

                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">{{ t('items') }}
                </div>
                <div style="font-weight: 500;" id="manage_info_items">-</div>
            </div>

            <!-- Focus 1: Delivery Status -->
            <div style="margin-bottom: 2rem;">
                <h4
                    style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                    {{ t('delivery_status') }}
                </h4>

                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{{ t('work_status')
                            }}</label>
                        <select name="status" id="manage_status" class="form-input" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                            <option value="Processing">{{ t('status_processing') }}</option>
                            <option value="Ready">{{ t('status_ready') }}</option>
                            <option value="Delivered">{{ t('status_delivered') }}</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{{ t('delivery_date')
                            }}</label>
                        <input type="date" name="delivery_date" id="manage_delivery_date" class="form-input" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                    </div>
                </div>
            </div>

            <!-- Focus 2: Payment Status -->
            <div style="margin-bottom: 1rem;">
                <h4
                    style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
                    {{ t('payment_status') }}
                </h4>

                <div style="margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="font-weight: 500;">{{ t('total_bill') }}</label>
                    </div>
                    <div style="position: relative;">
                        <span
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">₹</span>
                        <input type="number" name="total_amt" id="manage_total" class="form-input" required min="0"
                            step="0.01"
                            style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary); font-weight: 600;">
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="font-weight: 500;">{{ t('paid_amount') }}</label>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addFullPayment()"
                            style="font-size: 0.8rem; padding: 2px 8px; border: 1px solid var(--success-color); color: var(--success-color);">
                            <i class="fa-solid fa-check"></i> {{ t('mark_full_paid') }}
                        </button>
                    </div>
                    <div style="position: relative;">
                        <span
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">₹</span>
                        <input type="number" name="advance" id="manage_advance" class="form-input" required min="0"
                            step="0.01"
                            style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                    </div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem;">
                    <span style="color: var(--text-secondary);">{{ t('balance_due') }}:</span>
                    <span id="calc_balance" style="font-weight: 700; font-size: 1.1rem;">₹0</span>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{{ t('payment_mode')
                        }}</label>
                    <select name="payment_mode" id="manage_mode" class="form-input"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                        <option value="Cash">{{ t('cash') }}</option>
                        <option value="Online / UPI">{{ t('online_upi') }}</option>
                        <option value="Card">{{ t('card') }}</option>
                        <option value="Bank Transfer">{{ t('bank_transfer') }}</option>
                    </select>
                </div>
            </div>

            <div
                style="position: sticky; bottom: 0; background: var(--card-bg); padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; justify-content: center; padding: 1rem; font-size: 1rem;">
                    {{ t('update_order') }}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: flex-end;
    }

    .sidebar-panel {
        width: 100%;
        max-width: 450px;
        height: 100%;
        background: var(--card-bg);
        padding: 2rem;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        overflow-y: auto;
    }

    .sidebar-overlay.active .sidebar-panel {
        transform: translateX(0);
    }

    /* Mobile Improvements */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start !important;
            /* Override inline style */
            gap: 1rem;
        }

        /* Month Nav stack */
        .month-nav {
            width: 100%;
            justify-content: space-between;
        }

        .filter-bar {
            flex-direction: column;
            align-items: stretch !important;
        }

        .filter-bar div[style*="min-width: 200px"] {
            min-width: auto !important;
            width: 100%;
        }

        /* Pagination */
        div[style*="justify-content: space-between; align-items: center; padding-top: 1rem"] {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start !important;
        }

        /* --- Mobile Table Card View --- */
        table,
        thead,
        tbody,
        th,
        td,
        tr {
            display: block;
        }

        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        tr {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: var(--card-bg);
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        td {
            border: none;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
            padding: 0.5rem 0;
            padding-left: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        td:last-child {
            border-bottom: none;
            justify-content: flex-end;
            /* Actions to right */
            gap: 0.5rem;
        }

        /* Column Specifics */
        td:nth-of-type(1) {
            /* Order ID */
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
        }

        td:nth-of-type(1)::before {
            content: "Order ID";
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

        td:nth-of-type(2) {
            /* Customer */
            display: block;
            /* Allow name/mobile to stack naturally */
        }

        td:nth-of-type(6) {
            /* Balance */
            color: var(--text-primary);
            font-weight: 600;
        }

        td:nth-of-type(6)::before {
            content: "Balance";
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: auto;
            /* Push value to right */
        }
    }
</style>


{% endblock %}